name: Invalidate cache on comment

on:
  issue_comment:
    types: [created]
  pull_request:
    branches: [main]

permissions:
  contents: read
  issues: read
  pull-requests: write
  id-token: write
  statuses: write

jobs:
  check-comment:
    name: Check po4a changes to commit
    # if: (github.event.issue.pull_request && startsWith(github.event.comment.body, 'Invalidate cache'))
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}


    steps:
      - uses: xt0rted/pull-request-comment-branch@v2
        id: comment-branch

      - name: Set up repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.comment-branch.outputs.head_ref }}

      - name: Get cache prefix
        run: |
          comment="${{ env.COMMENT }}"
          cache_prefix="${comment#Invalidate cache }"
          echo "CACHE_PREFIX=$cache_prefix" >> $GITHUB_ENV
        env:
          # COMMENT: ${{ github.event.comment.body }}
          COMMENT: pdf-fr-01

      - name: List caches
        run: |
          gh api repos/${{ github.repository }}/actions/caches | jq -c '{caches: [.actions_caches[] | select(.key | startswith("${{ env.CACHE_PREFIX }}"))]}' > caches.json

      - name: Add comment
        run: |
          if [[ $(jq '.caches | length == 0' caches.json) == "true" ]]; then
            echo 'No caches found matching prefix `${{ env.CACHE_PREFIX }}`' >> body.txt
          else
            echo "CACHE_COUNT=$(jq '.caches | length' caches.json) " >> $GITHUB_ENV
            jq '.caches[] | { key,size: (if .size_in_bytes < 1024 then "\(.size_in_bytes) bytes"
                elif .size_in_bytes < 1048576 then "\(.size_in_bytes/1024 | floor) KB"
                elif .size_in_bytes < 1073741824 then "\(.size_in_bytes/1048576 | floor) MB"
            else "\(.size_in_bytes/1073741824 | floor) GB" end), ref, created_at, last_accessed_at, id, version }' caches.json >> formatted-caches.txt
            (
              echo 'Deleted ${{ env.CACHE_COUNT }} caches ðŸ’¾ matching prefix `${{ env.CACHE_PREFIX }}`'
              echo "<details><summary>Click to see the list</summary>"
              echo
              echo '```json'
              cat formatted-caches.txt
              echo '```'
              echo "</details>"
            ) >> body.txt
          fi
          gh pr comment ${{ steps.comment-branch.outputs.head_ref }} --body-file body.txt
